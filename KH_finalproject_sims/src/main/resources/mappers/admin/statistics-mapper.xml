<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="admin" >
	<!-- 요금제 랭킹 - 가입자 많은 순 -->
	<select id="selectOrderByRegistration" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
	<![CDATA[
		SELECT ROWNUM AS PLAN_LANKING, PLAN_NAME, CNT, BIZ_NAME
		FROM
		(
		    SELECT ROWNUM, PLAN_NO, PLAN_NAME, CNT, BIZ_NAME
		    FROM (
		        SELECT PLAN_NO, COUNT(*) AS CNT 
		        FROM PLAN_ORDER
		        GROUP BY PLAN_NO
		        ORDER BY CNT DESC
		    )
		    LEFT OUTER JOIN PLAN_TABLE USING (PLAN_NO)
		    WHERE ROWNUM <=5
		    ORDER BY CNT DESC
		)
    ]]>
	</select>
	
	<!-- 연령대별 가장 인기있는 요금제  -->
	<select id="selectAgeGroupPlans" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
		SELECT AGE_GROUP, BIZ_NAME, PLAN_NAME, CNT, RN
		FROM (
		    SELECT AGE_GROUP, BIZ_NAME, PLAN_NAME, COUNT(*) AS CNT,
		        ROW_NUMBER() OVER (PARTITION BY AGE_GROUP ORDER BY COUNT(*) DESC) AS RN
		    FROM (
		        SELECT PLAN_NO, USER_ID, USER_NAME, USER_SSN, PLAN_NAME, BIZ_NAME,
		            CASE 
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 10 AND 19 THEN '10대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 20 AND 29 THEN '20대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 30 AND 39 THEN '30대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 40 AND 49 THEN '40대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 50 AND 59 THEN '50대'
		                ELSE '60대+' 
		            END AS AGE_GROUP
		        FROM 
		            PLAN_ORDER 
		            LEFT OUTER JOIN USER_TABLE USING (USER_ID)
		            LEFT OUTER JOIN PLAN_TABLE USING (PLAN_NO) 
		    )
		    GROUP BY AGE_GROUP, BIZ_NAME, PLAN_NAME
		)
		WHERE RN = 1
		ORDER BY AGE_GROUP ASC
	</select>
	
	<!-- 별점순 통신사 랭킹  -->
	<select id="selectStarRating" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
		SELECT BIZ_NAME, BIZ_REVIEW_STAR FROM(
		SELECT BIZ_NAME, BIZ_REVIEW_STAR
		FROM BIZ
		ORDER BY BIZ_REVIEW_STAR DESC)
		 <![CDATA[ WHERE ROWNUM <= 5 ]]>
	</select>
	
	<!-- 월별 요금제 총 가입자 수  -->
	<select id="selectMonthlyPlanOrderCount" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo" >
		   SELECT ORDER_MONTH, COUNT(*) AS CNT
		    FROM
		    (SELECT USER_ID,
		    CASE 
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM SYSDATE) THEN EXTRACT(MONTH FROM SYSDATE)||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -2)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -2))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -3)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -3))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -4)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -4))||'월'
		    END AS ORDER_MONTH
		FROM 
		    PLAN_ORDER
		    GROUP BY USER_ID,     
		    CASE 
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM SYSDATE) THEN EXTRACT(MONTH FROM SYSDATE)||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -2)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -2))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -3)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -3))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -4)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -4))||'월'
		    END
		    ORDER BY ORDER_MONTH)
		    GROUP BY ORDER_MONTH
		    ORDER BY ORDER_MONTH
	</select>
	
	<!-- 연령대 별 총 가입자 수  -->
	<select id="selectAgeGroupPlanOrderCount" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
		SELECT AGE_GROUP, COUNT(*) AS CNT
		FROM
		(SELECT USER_ID,
		            CASE 
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 10 AND 19 THEN '10대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 20 AND 29 THEN '20대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 30 AND 39 THEN '30대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 40 AND 49 THEN '40대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 50 AND 59 THEN '50대'
		                ELSE '60대+' 
		            END AS AGE_GROUP
		FROM 
		    PLAN_ORDER
		    LEFT OUTER JOIN USER_TABLE USING (USER_ID)
		    GROUP BY USER_ID,             
		    CASE 
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 10 AND 19 THEN '10대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 20 AND 29 THEN '20대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 30 AND 39 THEN '30대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 40 AND 49 THEN '40대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 50 AND 59 THEN '50대'
		            ELSE '60대+' 
		        END
		    ORDER BY AGE_GROUP)
		    GROUP BY AGE_GROUP
		    ORDER BY AGE_GROUP
	</select>
	
	<!-- 일별(7일 이내) 총 가입자 수 변화 -->
	<select id="selectDailyTotalUserWriteCount" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
	<![CDATA[
		SELECT TO_CHAR(TRUNC(CALENDAR_DATE), 'YYYY-MM-DD') AS USER_WR_DATE, NVL(CNT, 0) AS CNT
		FROM
		(
		  SELECT TRUNC(SYSDATE) - LEVEL + 1 AS CALENDAR_DATE
		  FROM DUAL
		  CONNECT BY LEVEL <= 7
		) CALENDAR
		LEFT OUTER JOIN
		(
		  SELECT TRUNC(USER_WR_DATE) AS USER_WR_DATE, COUNT(*) AS CNT
		  FROM USER_TABLE
		  WHERE USER_WR_DATE >= TRUNC(SYSDATE) - 6 AND USER_WR_DATE < TRUNC(SYSDATE) + 1
		  GROUP BY TRUNC(USER_WR_DATE)
		) USER_COUNT
		ON CALENDAR.CALENDAR_DATE = USER_COUNT.USER_WR_DATE
		ORDER BY TRUNC(CALENDAR_DATE) ASC
	 ]]>
	</select>
	
	<!-- 일별(7일 이내) 성별 가입자 수 변화 -->
	<select id="selectDailyGenderUserWriteCount" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
	<![CDATA[
		SELECT TO_CHAR(TRUNC(CALENDAR_DATE), 'YYYY-MM-DD') AS USER_WR_DATE,
		  SUM(CASE WHEN USER_GENDER = 'M' THEN CNT ELSE 0 END) AS MALE_CNT,
		  SUM(CASE WHEN USER_GENDER = 'F' THEN CNT ELSE 0 END) AS FEMALE_CNT
		FROM
		(
		  SELECT TRUNC(SYSDATE) - LEVEL + 1 AS CALENDAR_DATE
		  FROM DUAL
		  CONNECT BY LEVEL <= 7
		) CALENDAR
		LEFT OUTER JOIN
		(
		  SELECT TRUNC(USER_WR_DATE) AS USER_WR_DATE, USER_GENDER, COUNT(*) AS CNT
		  FROM USER_TABLE
		  WHERE USER_WR_DATE >= TRUNC(SYSDATE) - 6 AND USER_WR_DATE < TRUNC(SYSDATE) + 1
		  GROUP BY TRUNC(USER_WR_DATE), USER_GENDER
		) USER_COUNT
		ON CALENDAR.CALENDAR_DATE = USER_COUNT.USER_WR_DATE
		GROUP BY TO_CHAR(TRUNC(CALENDAR_DATE), 'YYYY-MM-DD')
		ORDER BY TO_CHAR(TRUNC(CALENDAR_DATE), 'YYYY-MM-DD') ASC
	 ]]>
	</select>
	
	<!-- 성별 가입자 수 비율 -->
	<select id="selectGenderRatioByTotalUserRatio" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
	<![CDATA[
		SELECT COUNT(*) AS TOTAL_CNT,
		  SUM(CASE WHEN USER_GENDER = 'M' THEN 1 ELSE 0 END) AS MALE_COUNT,
		  SUM(CASE WHEN USER_GENDER = 'F' THEN 1 ELSE 0 END) AS FEMALE_COUNT,
		  ROUND(SUM(CASE WHEN USER_GENDER = 'M' THEN 1 ELSE 0 END) / COUNT(*) * 100, 2) AS MALE_RATIO,
		  ROUND(SUM(CASE WHEN USER_GENDER = 'F' THEN 1 ELSE 0 END) / COUNT(*) * 100, 2) AS FEMALE_RATIO
		FROM
		(SELECT USER_WR_DATE, USER_GENDER
		FROM USER_TABLE)
	 ]]>
	</select>
	
	<!-- 연령대 가입자 수 비율 -->
	<select id="selectAgeGroupByTotalUserRatio" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
	<![CDATA[
		SELECT AGE_GROUP,
		       COUNT(*) AS AGE_GROUP_COUNT,
		       ROUND(COUNT(*) / (SELECT COUNT(*) FROM USER_TABLE) * 100, 2) AS AGE_GROUP_RATIO
		FROM (
		  SELECT CASE 
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 10 AND 19 THEN '10대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 20 AND 29 THEN '20대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 30 AND 39 THEN '30대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 40 AND 49 THEN '40대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 50 AND 59 THEN '50대'
		            ELSE '60대+' 
		        END AS AGE_GROUP
		  FROM USER_TABLE
		)
		GROUP BY AGE_GROUP
		ORDER BY AGE_GROUP
	]]>
	</select>
</mapper>
