<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="admin" >
	<!-- 요금제 랭킹 - 가입자 많은 순 -->
	<select id="selectOrderByRegistration" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
		select rownum, plan_no, plan_name, cnt, biz_name
	    from (
	    select plan_no, count(*)as cnt 
	    from plan_order
	    group by plan_no
	    order by cnt desc
	    )
	    left outer join plan_table using (plan_no)
	    <![CDATA[ where rownum <=5 ]]>
	    order by cnt desc
	</select>
	
	<!-- 연령대별 가장 인기있는 요금제  -->
	<select id="selectAgeGroupPlans" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
		SELECT AGE_GROUP, BIZ_NAME, PLAN_NAME, CNT, RN
		FROM (
		    SELECT AGE_GROUP, BIZ_NAME, PLAN_NAME, COUNT(*) AS CNT,
		        ROW_NUMBER() OVER (PARTITION BY AGE_GROUP ORDER BY COUNT(*) DESC) AS RN
		    FROM (
		        SELECT PLAN_NO, USER_ID, USER_NAME, USER_SSN, PLAN_NAME, BIZ_NAME,
		            CASE 
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 10 AND 19 THEN '10대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 20 AND 29 THEN '20대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 30 AND 39 THEN '30대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 40 AND 49 THEN '40대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 50 AND 59 THEN '50대'
		                ELSE '60+' 
		            END AS AGE_GROUP
		        FROM 
		            PLAN_ORDER 
		            LEFT OUTER JOIN USER_TABLE USING (USER_ID)
		            LEFT OUTER JOIN PLAN_TABLE USING (PLAN_NO) 
		    )
		    GROUP BY AGE_GROUP, BIZ_NAME, PLAN_NAME
		)
		WHERE RN = 1
		ORDER BY AGE_GROUP ASC
	</select>
	
	<!-- 별점순 통신사 랭킹  -->
	<select id="selectStarRating" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
		SELECT BIZ_NAME, BIZ_REVIEW_STAR FROM(
		SELECT BIZ_NAME, BIZ_REVIEW_STAR
		FROM BIZ
		ORDER BY BIZ_REVIEW_STAR DESC)
		 <![CDATA[ WHERE ROWNUM <= 5 ]]>
	</select>
	
	<!-- 월별 요금제 총 가입자 수  -->
	<select id="selectMonthlyPlanOrderCount" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo" >
		   SELECT ORDER_MONTH, COUNT(*) AS CNT
		    FROM
		    (SELECT USER_ID,
		    CASE 
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM SYSDATE) THEN EXTRACT(MONTH FROM SYSDATE)||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -2)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -2))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -3)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -3))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -4)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -4))||'월'
		    END AS ORDER_MONTH
		FROM 
		    PLAN_ORDER
		    GROUP BY USER_ID,     
		    CASE 
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM SYSDATE) THEN EXTRACT(MONTH FROM SYSDATE)||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -2)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -2))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -3)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -3))||'월'
		        WHEN EXTRACT(MONTH FROM ORDER_DATE) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -4)) THEN EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -4))||'월'
		    END
		    ORDER BY ORDER_MONTH)
		    GROUP BY ORDER_MONTH
		    ORDER BY ORDER_MONTH
	</select>
	
	<!-- 연령대 별 총 가입자 수  -->
	<select id="selectAgeGroupPlanOrderCount" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
		SELECT AGE_GROUP, COUNT(*) AS CNT
		FROM
		(SELECT USER_ID,
		            CASE 
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 10 AND 19 THEN '10대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 20 AND 29 THEN '20대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 30 AND 39 THEN '30대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 40 AND 49 THEN '40대'
		                WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 50 AND 59 THEN '50대'
		                ELSE '60+' 
		            END AS AGE_GROUP
		FROM 
		    PLAN_ORDER
		    LEFT OUTER JOIN USER_TABLE USING (USER_ID)
		    GROUP BY USER_ID,             
		    CASE 
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 10 AND 19 THEN '10대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 20 AND 29 THEN '20대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 30 AND 39 THEN '30대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 40 AND 49 THEN '40대'
		            WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(USER_SSN, 1, 6), 'RRMMDD'))/12) BETWEEN 50 AND 59 THEN '50대'
		            ELSE '60+' 
		        END
		    ORDER BY AGE_GROUP)
		    GROUP BY AGE_GROUP
		    ORDER BY AGE_GROUP
	</select>
	
	<!-- 일별(7일 이내) 가입자 수 변화 -->
	<select id="selectDailyUserWriteCount" resultType="kh.finalproject.sims.admin.model.vo.AdminStatisticsVo">
	<![CDATA[
	    SELECT TRUNC(USER_WR_DATE), COUNT(*) AS CNT
	    FROM
	    (SELECT USER_NAME,
	       TRUNC(USER_WR_DATE) AS USER_WR_DATE
	        FROM USER_TABLE
	        WHERE USER_WR_DATE >= TRUNC(SYSDATE) - 6 AND USER_WR_DATE < TRUNC(SYSDATE) + 1
	        ORDER BY USER_WR_DATE ASC
	        )
	    GROUP BY USER_WR_DATE
	    ORDER BY USER_WR_DATE
	 ]]>
	</select>
</mapper>
